<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Página de configurações do aplicativo" />
    <title>Configurações</title>
    <link rel="stylesheet" href="../static/CSS/PaginaConfig.css" />
    <script type="text/javascript" src="https://cdn.rybena.com.br/dom/master/latest/rybena.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  </head>
  <body>
    <!-- ONDAS NO FUNDO -->
    <div class="wave">
      <span></span>
      <span></span>
      <span></span>
    </div>

    <!-- CONTEÚDO PRINCIPAL -->
    <div class="config-page">
      <!-- Bloco esquerdo -->
      <div class="config-left">
        <!-- Abas -->
        <div class="tabs">
          <button class="tab-button active" data-tab="personal">
            Configurações Pessoais
          </button>
          <button class="tab-button" data-tab="other">
            Outras Configurações
          </button>
        </div>

        <!-- Conteúdo da aba Pessoais -->
        <div class="tab-content active" id="personal">
          <form action="{{ url_for('auth.redefinir') }}" method="POST" class="redefinir_senha">
            <div>
              <label for="email">Digite seu E-mail</label>
              <input type="text" name="email" />
              <br />
              <label for="senha">Digite sua nova senha</label>
              <input type="text" name="senha" />
              <br />
              <div>
                <button type="submit">Redefinir Senha</button>
              </div>
            </div>
          </form>
        </div>

        <!-- Conteúdo da aba Outras -->
        <div class="tab-content" id="other">
          <form>
            <div class="form-row">
              <label>Tema:</label>
              <div class="toggle-group">
                <button type="button" class="toggle active">Claro</button>
                <button type="button" class="toggle">Escuro</button>
              </div>
            </div>
            <hr />
            <h3>ÁREA DE RISCO</h3>
            <div class="danger-zone">
              <div>
                <h4>Reiniciar progresso</h4>
                <p>
                  Atenção: ao reiniciar, todo o seu progresso será perdido e não
                  poderá ser recuperado.
                </p>
                <button type="button" class="danger">Limpar dados</button>
              </div>
              <div>
                <h4>Excluir Conta</h4>
                <p>
                  Atenção: ao excluir, todo o seu progresso será perdido e não
                  poderá ser recuperado.
                </p>
                <button type="button" id="excluirContaBtn" class="danger">
                  Excluir minha conta
                </button>
              </div>
            </div>
            <div class="form-actions">
              <button type="reset" class="danger">
                Descartar as alterações
              </button>
              <button type="submit" class="success">
                Salvar as alterações
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Bloco direito -->
      <div class="config-right">
        <div class="avatar">
          <div class="avatar-img">
            <img
              src="{{ url_for('static', filename='assets/' + (usuario_avatar or 'raposa.png')) }}"
              alt="Avatar atual"
            />
          </div>
          <h3>Escolha seu personagem:</h3>
          <form action="{{ url_for('avatar.atualizar_avatar') }}" method="POST">
            <div class="characters">
              <button type="submit" name="avatar" value="gaviao.png" class="icon">
                <img src="{{ url_for('static', filename='assets/gaviao.png') }}" alt="Gavião" />
              </button>
              <button type="submit" name="avatar" value="jacare.png" class="icon">
                <img src="{{ url_for('static', filename='assets/jacare.png') }}" alt="Jacaré" />
              </button>
              <button type="submit" name="avatar" value="onca-pintada.png" class="icon">
                <img src="{{ url_for('static', filename='assets/onca-pintada.png') }}" alt="Onça-pintada" />
              </button>
              <button type="submit" name="avatar" value="raposa.png" class="icon">
                <img src="{{ url_for('static', filename='assets/raposa.png') }}" alt="Raposa" />
              </button>
              <button type="submit" name="avatar" value="tucano.png" class="icon">
                <img src="{{ url_for('static', filename='assets/tucano.png') }}" alt="Tucano" />
              </button>
              <button type="submit" name="avatar" value="urso.png" class="icon">
                <img src="{{ url_for('static', filename='assets/urso.png') }}" alt="Urso" />
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal de confirmação -->
    <div id="deleteModal" class="modal">
      <div class="modal-content">
        <h3>Excluir Conta</h3>
        <p>Tem certeza que deseja excluir sua conta? Esta ação não pode ser desfeita.</p>
        <input type="password" id="confirmPassword" placeholder="Digite sua senha para confirmar" />
        <div class="modal-buttons">
          <button id="cancelDelete" class="btn-cancelar">Cancelar</button>
          <button id="confirmDelete" class="btn-confirmar">Excluir</button>
        </div>
      </div>
    </div>

    <!-- Navbar -->
    <nav class="bottom-navbar">
      <ul>
        <li>
          <a href="{{ url_for('home') }}">
            <i class="fas fa-home"></i>
            <span class="nav-text">Início</span>
          </a>
        </li>
        <li>
          <a href="{{ url_for('classes') }}">
            <i class="fas fa-chalkboard-teacher"></i>
            <span class="nav-text">Classes</span>
          </a>
        </li>
        <li>
          <a href="{{ url_for('activities') }}">
            <i class="fas fa-running"></i>
            <span class="nav-text">Activities</span>
          </a>
        </li>
        <li>
          <a href="{{ url_for('games') }}">
            <i class="fas fa-gamepad"></i>
            <span class="nav-text">Games</span>
          </a>
        </li>
        <li>
          <a href="{{ url_for('configuracoes') }}">
            <i class="fas fa-user-circle"></i>
            <span class="nav-text">Perfil</span>
          </a>
        </li>
        <li>
          <a href="{{ url_for('apoiadores') }}">
            <i class="fas fa-life-ring"></i>
            <span class="nav-text">Apoio</span>
          </a>
        </li>
      </ul>
    </nav>

    <script>
      // Função para alternar entre abas E ajustar a altura
      document.addEventListener("DOMContentLoaded", function () {
        const tabButtons = document.querySelectorAll(".tab-button");
        const tabContents = document.querySelectorAll(".tab-content");
        const configLeft = document.querySelector(".config-left"); // <--- Adicionado: Seleciona o elemento que terá a altura alterada

        // Função que ajusta a altura de .config-left
        function adjustHeight(tabId) {
            if (configLeft) {
                if (tabId === "personal") {
                    configLeft.style.height = "380px"; // Altura para a aba Pessoal
                } else if (tabId === "other") {
                    configLeft.style.height = "500px"; // Altura para a aba Other
                }
            }
        }

        // Chamada inicial para garantir a altura correta ao carregar a página
        const activeTabButton = document.querySelector(".tab-button.active");
        if (activeTabButton) {
            adjustHeight(activeTabButton.getAttribute("data-tab"));
        }

        tabButtons.forEach((button) => {
          button.addEventListener("click", function () {
            tabButtons.forEach((btn) => btn.classList.remove("active"));
            tabContents.forEach((content) => content.classList.remove("active"));
            this.classList.add("active");
            const tabId = this.getAttribute("data-tab");
            document.getElementById(tabId).classList.add("active");
            
            // CHAMA A FUNÇÃO DE AJUSTE DE ALTURA
            adjustHeight(tabId); 
          });
        });

        // Função para toggle de tema (claro/escuro)
        const temaClaroBtn = document.querySelector(".toggle-group .toggle:first-child");
        const temaEscuroBtn = document.querySelector(".toggle-group .toggle:last-child");
        function aplicarTema(tema) {
          if (tema === "escuro") {
            document.body.classList.add("dark-theme");
            temaClaroBtn?.classList.remove("active");
            temaEscuroBtn?.classList.add("active");
          } else {
            document.body.classList.remove("dark-theme");
            temaClaroBtn?.classList.add("active");
            temaEscuroBtn?.classList.remove("active");
          }
        }
        const temaSalvo = localStorage.getItem("tema");
        if (temaSalvo) {
          aplicarTema(temaSalvo);
        }
        temaClaroBtn?.addEventListener("click", function () {
          aplicarTema("claro");
          localStorage.setItem("tema", "claro");
        });
        temaEscuroBtn?.addEventListener("click", function () {
          aplicarTema("escuro");
          localStorage.setItem("tema", "escuro");
        });

        // Função para o modal de exclusão de conta
        document.getElementById('excluirContaBtn').addEventListener('click', () => {
          document.getElementById('deleteModal').style.display = 'flex';
        });

        document.getElementById('cancelDelete').addEventListener('click', () => {
          document.getElementById('deleteModal').style.display = 'none';
        });

        document.getElementById('confirmDelete').addEventListener('click', async () => {
          const password = document.getElementById('confirmPassword').value;
          if (!password) {
            alert('Por favor, digite sua senha para confirmar.');
            return;
          }

          try {
            const response = await fetch('/auth/excluir_conta', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({ password: password })
            });

            const data = await response.json();
            if (data.success) {
              alert('Conta excluída com sucesso!');
              window.location.href = '/';
            } else {
              alert(`Erro: ${data.message}`);
            }
          } catch (error) {
            console.error('Erro:', error);
            alert('Ocorreu um erro ao excluir a conta.');
          }
        });
      });
    </script>
  </body>
</html>
